<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">


<dom-module id="dory-login">
    <template>
        <style>
            :host {
                display: block;
                background-color: var(--background-color);
            }

            .container{
                display:table-cell;
                vertical-align: middle;
                height : 100vh;
                width  : 100vw;
            }

            .form{
                background-color : white;
                width : 30vw;
                min-width : 450px;
                margin : auto;
                height : 300px;
                box-shadow : 0 0 1px #424242;
                padding: 50px;
            }

            .form-control{
                height : 3em;
                width : 80%;
                margin : 50px;
            }

            .form-button {
                margin-top : 30px;
                float : right;
            }


        </style>
        <div class="container">
            <div class="form">
                <paper-input id="username" error-message="[[errorMessage]]" class="form-control" label="username" value="{{data.username}}" required></paper-input>
                <paper-input id="password" error-message="[[errorMessage]]" class="form-control" label="password" type="password" value="{{data.password}}" required></paper-input>
                <paper-button class="form-button" on-tap="_handleLogin">Login</paper-button>
            </div>
        </div>

    </template>

    <script>
        /**
         * `dory-login`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class DoryLogin extends Polymer.Element {
            static get is() {
                return 'dory-login';
            }

            static get properties() {
                return {
                    data: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return {
                                username: "sarah@mail.com",
                                password: 'sarah123'
                            }
                        }
                    },
                    errorMessage: {
                        type: String,
                        notify: true
                    }
                };
            }

            _handleLogin(e) {
                this.errorMessage = undefined;
                const myHeaders = new Headers({
                    'Accept': 'application/json',
                    'Content-Type': 'application/x-www-form-urlencoded'
                });
                let formBody = [];
                formBody.push(encodeURIComponent('username') + "=" + this.data.username);
                formBody.push(encodeURIComponent('password') + "=" + this.data.password);
                formBody = formBody.join("&");
                window.fetch('/api/tokens', {
                    method: 'POST',
                    headers: myHeaders,
                    credentials: 'same-origin',
                    body: formBody
                }).then(this._checkResponseStatus.bind(this)).then(response => {
                    return response.json();
                }).then(json => {
                    this.fireLoginSucess(json);
                    return json;
                }).catch(this._handleErrorRetrieve.bind(this));
            }

            _isResponseJson(response) {
                const contentType = response.headers.get('content-type');
                return (contentType && contentType.indexOf('application/json') !== -1)
            };


            _checkResponseStatus(response) {
                if (!response.ok) {
                    const error = new Error(response.status + ' (' + response.statusText + ')');
                    error.status = response.status;
                    error.statusText = response.statusText;
                    // Manage
                    if (this._isResponseJson(response)) {
                        return response.json().then(function (json) {
                            error.responseJson = json;
                            error.responseText = JSON.stringify(json);
                            return Promise.reject(error);
                        });
                    } else {
                        return response.text().then(function (text) {
                            error.responseText = text;
                            return Promise.reject(error);
                        });
                    }
                }
                return response;
            };

            _handleErrorRetrieve(e) {
                    const status = e.status;
                    console.log('_handle Error status :', status);
                    console.log('_handle Error Text :', e.responseText);
                    this.errorMessage = 'mauvais mot de passe ou identifiant inexistant';
                    // FIXME display Error
                    return e;
            }


            fireLoginSucess(user) {
                console.log('LoginSucess', JSON.stringify(user));
                this.dispatchEvent(new CustomEvent('dory-login-success', {detail: {user}, bubbles: true, composed: true}));
            }

        }

        window.customElements.define(DoryLogin.is, DoryLogin);
    </script>
</dom-module>
